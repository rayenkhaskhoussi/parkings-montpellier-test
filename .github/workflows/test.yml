name: üß™ Test Parking Data Collection

on:
  # Allows manual trigger from GitHub website
  workflow_dispatch:
  # Also runs on push to main branch (for testing)
  push:
    branches: [ main ]

jobs:
  test-collection:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Safety limit
    
    steps:
    # 1. Get the code
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get all history
    
    # 2. Setup Python
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. Install packages
    - name: üì¶ Install dependencies
      run: pip install -r requirements.txt
    
    # 4. Run the 15-minute test
    - name: üß™ Run test collection
      run: python test_collect.py
    
    # 5. Display results
    - name: üìä Show test summary
      run: |
        echo "=== TEST RESULTS ==="
        if [ -f "test_summary.txt" ]; then
          cat test_summary.txt
        else
          echo "‚ùå No summary file created"
        fi
        echo "==================="
    
    # 6. Save test files to repository
    - name: üíæ Commit test results
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # Add test files
        git add test_results.json test_summary.txt 2>/dev/null || true
        
        # Commit if there are changes
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è No test files to commit"
        else
          git commit -m "Test results: $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "‚úÖ Test results committed to repository"
        fi
