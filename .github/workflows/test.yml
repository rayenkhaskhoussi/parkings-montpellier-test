name: Daily Parking Tests Archive

on:
  schedule:
    # Ex√©cute √† 2h, 8h, 14h, 20h UTC (4 fois par jour)
    - cron: '0 2,8,14,20 * * *'
  workflow_dispatch:  # Pour lancer manuellement

jobs:
  archive-daily-tests:
    runs-on: ubuntu-latest
    
    # Emp√™che les ex√©cutions multiples en parall√®le
    concurrency:
      group: daily-tests-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    # √âTAPE 1: CHECKOUT avec permissions compl√®tes
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # IMPORTANT: r√©cup√®re tout l'historique
    
    # √âTAPE 2: SYNCHRONISATION ABSOLUE avec le remote
    - name: Force sync with remote
      run: |
        git fetch origin
        git reset --hard origin/main
        git clean -fd
    
    # √âTAPE 3: SETUP PYTHON
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    # √âTAPE 4: EX√âCUTE TON CODE PYTHON
    - name: Run existing Python tests
      run: |
        # TON CODE EXISTANT - ne change rien
        python run_tests.py  # ou le nom de ton script
    
    # √âTAPE 5: ARCHIVAGE PAR JOUR ET HEURE
    - name: Archive results with timestamp
      run: |
        # Date et heure exactes
        DATE=$(date -u +'%Y-%m-%d')
        DAY_NUM=$(date -u +'%d')
        TIME=$(date -u +'%H-%M-%S')
        FULL_TIMESTAMP="${DATE}_${TIME}"
        
        # Cr√©e le dossier du jour s'il n'existe pas
        mkdir -p "jour-$DAY_NUM"
        
        # 1. Archive les fichiers originaux avec timestamp
        cp test_results.json "jour-$DAY_NUM/test_results_${FULL_TIMESTAMP}.json"
        cp test_summary.txt "jour-$DAY_NUM/summary_${FULL_TIMESTAMP}.txt"
        
        # 2. Garde une copie "latest" dans le dossier du jour
        cp test_results.json "jour-$DAY_NUM/test_results_LATEST.json"
        cp test_summary.txt "jour-$DAY_NUM/summary_LATEST.txt"
        
        # 3. Mets √† jour le fichier master du jour
        echo "üìä R√©sultats du jour - $DATE" > "jour-$DAY_NUM/README.md"
        echo "==============================" >> "jour-$DAY_NUM/README.md"
        echo "" >> "jour-$DAY_NUM/README.md"
        echo "Derni√®re ex√©cution: $DATE √† $TIME UTC" >> "jour-$DAY_NUM/README.md"
        echo "" >> "jour-$DAY_NUM/README.md"
        
        # Ajoute le contenu du summary
        if [ -f test_summary.txt ]; then
          echo "**R√©sum√©:**" >> "jour-$DAY_NUM/README.md"
          echo '```' >> "jour-$DAY_NUM/README.md"
          cat test_summary.txt >> "jour-$DAY_NUM/README.md"
          echo '```' >> "jour-$DAY_NUM/README.md"
        fi
        
        # 4. Met √† jour le fichier historique global
        if [ ! -f "HISTORIQUE.md" ]; then
          echo "# üìÖ Historique Complet des Tests" > HISTORIQUE.md
          echo "" >> HISTORIQUE.md
          echo "| Jour | Date | Derni√®re ex√©cution | Statut | Parking | Total |" >> HISTORIQUE.md
          echo "|------|------|-------------------|--------|---------|-------|" >> HISTORIQUE.md
        fi
        
        # Extrait les donn√©es du summary
        STATUS="üü°"
        if grep -q "‚úÖ SUCCESS" test_summary.txt; then
          STATUS="‚úÖ"
        elif grep -q "‚ùå FAIL" test_summary.txt; then
          STATUS="‚ùå"
        fi
        
        PARKINGS=$(grep "Parkings found:" test_summary.txt | grep -o '[0-9]*' || echo "0")
        TOTAL=$(grep "Total records:" test_summary.txt | grep -o '[0-9]*' || echo "0")
        
        # V√©rifie si cette journ√©e existe d√©j√† dans l'historique
        if grep -q "| $DAY_NUM | $DATE |" HISTORIQUE.md; then
          # Met √† jour la ligne existante
          sed -i "/| $DAY_NUM | $DATE |/c\| $DAY_NUM | $DATE | $TIME | $STATUS | $PARKINGS | $TOTAL |" HISTORIQUE.md
        else
          # Ajoute une nouvelle ligne
          echo "| $DAY_NUM | $DATE | $TIME | $STATUS | $PARKINGS | $TOTAL |" >> HISTORIQUE.md
        fi
        
        # 5. Trie l'historique par jour
        head -n 5 HISTORIQUE.md > HISTORIQUE_TEMP.md
        tail -n +6 HISTORIQUE.md | sort -t '|' -k2,2 >> HISTORIQUE_TEMP.md
        mv HISTORIQUE_TEMP.md HISTORIQUE.md
    
    # √âTAPE 6: CONFIGURE GIT
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    # √âTAPE 7: V√âRIFIE LES CHANGEMENTS
    - name: Check for changes
      id: check_changes
      run: |
        if git status --porcelain | grep -q "."; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    # √âTAPE 8: COMMIT ET PUSH (FORCE - n√©cessaire)
    - name: Commit and push archives
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git add .
        git commit -m "üìÅ Archive: Jour $(date -u +'%d') - $(date -u +'%H:%M UTC')"
        git push origin main --force-with-lease
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # √âTAPE 9: SI PAS DE CHANGEMENTS
    - name: No changes to commit
      if: steps.check_changes.outputs.has_changes == 'false'
      run: echo "‚úÖ Aucun changement d√©tect√© - les r√©sultats sont identiques."
